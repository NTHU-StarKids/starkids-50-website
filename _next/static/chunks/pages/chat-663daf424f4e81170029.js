(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[180],{4314:function(e,t,r){"use strict";r.d(t,{zG:function(){return d},P4:function(){return f},IU:function(){return m}});var n=r(266),a=r(809),l=r.n(a),s=r(9669),c=r.n(s),o=r(6264),i=c().create({baseURL:"https://starkids-50-nodejs.herokuapp.com/"}),u=function(){var e=(0,n.Z)(l().mark((function e(t){var r,n,a,s,c,u,d;return l().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.url,n=t.method,a=void 0===n?"POST":n,s=t.body,c=o.decamelizeKeys(s),e.next=4,i({url:r,method:a,data:c});case 4:return u=e.sent,d=o.camelizeKeys(u.data),e.abrupt("return",d);case 7:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),d=function(){return u({url:"/chats",method:"GET"})},f=function(e,t,r){return u({url:"/chats",method:"POST",body:{name:e,text:t,profile:r}})},m=function(e){return u({url:"/signup",method:"POST",body:e})}},2729:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return O}});var n=r(2809),a=r(266),l=r(809),s=r.n(l),c=r(7484),o=r.n(c),i=r(7294),u=r(7814),d=r(9398),f=r(4314),m=r(8315),h=r(5077),p=r(8813),x=r(6612),g=r(7687),v=r(8767),w=r(5893);function b(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}var j="profile-01",y=function(e){var t=JSON.parse(localStorage.getItem("chatIds"))||[];t.push(e);var r=Array.from(new Set(t));localStorage.setItem("chatIds",JSON.stringify(r))},N=function(e){var t=e.name,r=e.profileUrl,n=e.isSelf,a=e.sentAt,l=e.messages;return(0,w.jsxs)("div",{className:"flex w-full sm:w-5/6 md:w-4/5 lg:w-2/3 ".concat(n?"flex-row-reverse ml-auto":""),children:[(0,w.jsx)("div",{className:"w-8 md:w-12",children:(0,w.jsx)("div",{className:"relative w-8 md:w-12 h-8 md:h-12 rounded-full bg-center bg-cover",style:{backgroundImage:"url('".concat(r,"')")}})}),(0,w.jsx)("div",{className:"w-full text-left px-2 md:px-3",children:l.map((function(e,r){return(0,w.jsxs)("div",{className:"font-light",children:[0==r&&(n?(0,w.jsxs)("p",{className:"tracking-wide text-gray-50 leading-4 text-right cursor-default select-none",children:[(0,w.jsx)("span",{className:"mr-2 text-sm text-gray-200",children:o()(a).format("YYYY/MM/DD HH:mm")}),t]}):(0,w.jsxs)("p",{className:"tracking-wide text-gray-50 leading-4 cursor-default select-none",children:[t,(0,w.jsx)("span",{className:"ml-2 text-sm text-gray-200",children:o()(a).format("YYYY/MM/DD HH:mm")})]})),(0,w.jsx)("div",{className:"w-full flex ".concat(n?"justify-end":"justify-start"),children:(0,w.jsx)("div",{className:"mt-1 p-3 rounded-2xl tracking-wide ".concat(n?"bg-purple-600 text-white":"bg-white text-black"," ").concat(0==r?n?"rounded-tr-none":"rounded-tl-none":""),title:o()(a).format("YYYY/MM/DD HH:mm:ss"),children:(0,w.jsx)(p.Z,{text:e.text})})})]},"message-".concat(r))}))})]})},k=function(e){var t=e.disabled,r=e.messageGroups,l=e.refetchChats,c=(0,i.useState)(""),o=c[0],p=c[1],x=(0,i.useState)(""),v=x[0],k=x[1],O=(0,i.useState)(j),S=O[0],I=O[1],P=(0,i.useRef)(),C=(0,i.useRef)(),D=function(){var e=(0,a.Z)(s().mark((function e(){var r;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t||!v||!v.split(/\n|\r|\r\n/g).join("")){e.next=5;break}return e.next=3,(0,f.P4)(o||"\u533f\u540d",v,S);case 3:(r=e.sent)&&(y(r.id),k(""),C.current.click(),P.current.focus(),l());case 5:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),E=function(e){t||"Enter"!==e.key||e.nativeEvent.isComposing||e.shiftKey||"ontouchstart"in window||navigator.maxTouchPoints>0||(D(),e.preventDefault())};return(0,i.useEffect)((function(){var e=localStorage.getItem("profile")||j,t=g.hm.findIndex((function(t){return t==e}));-1===t?localStorage.setItem("profile",j):I(g.hm[t]);var r=localStorage.getItem("chatNickname");r&&p(r)}),[]),(0,w.jsxs)(h.Z,{children:[(0,w.jsx)(m.H2,{className:"mb-10",children:"\u7559\u8a00\u677f"}),(0,w.jsxs)("div",{className:"relative",children:[(0,w.jsx)("div",{className:"absolute w-full -top-4 flex justify-center z-30",children:(0,w.jsx)("div",{className:"rounded-full bg-purple-500 h-8 px-4 py-2 text-base sm:text-lg leading-4 sm:leading-4 tracking-wider select-none",children:t?(0,w.jsx)(u.G,{className:"animate-spin h-4 mx-2 inline",icon:d.UO1}):"\u6e05\u5927\u5929\u658750\u5e74\u751f\u65e5\u5feb\u6a02 \ud83c\udf89"})}),(0,w.jsxs)("div",{className:"relative bg-gray-600 w-full h-116 sm:h-132 md:h-148 lg:h-164 xl:h-180 2xl:h-200 rounded-xl",children:[(0,w.jsxs)("div",{className:"absolute left-0 bottom-24 w-full h-92 sm:h-108 md:h-124 lg:h-140 xl:h-156 2xl:h-176 overflow-hidden",children:[(0,w.jsx)("div",{className:"absolute top-0 w-full h-full flex place-content-center transition-opacity duration-700 z-10 opacity-100 ".concat(t?"":"opacity-0"),children:(0,w.jsx)("svg",{className:"my-auto animate-spin h-10 w-10 rounded-full bg-transparent border-4 border-purple-500 border-opacity-90",viewBox:"0 0 24 24",style:{borderRightColor:"#F8F7FD"}})}),(0,w.jsx)("div",{className:"absolute w-full h-full z-20 transition-opacity duration-700 ".concat(t?"opacity-0":"opacity-100"),children:(0,w.jsx)("div",{className:"absolute bottom-0 w-full px-0.5 pt-2 pb-1 overflow-hidden",children:(0,w.jsx)("div",{className:"w-full max-h-88 sm:max-h-104 md:max-h-120 lg:max-h-136 xl:max-h-152 2xl:max-h-172 flex flex-col gap-4 px-2 pb-3 pt-6 lg:p-4 overflow-x-hidden overflow-y-scroll",children:r.map((function(e,t){return(0,w.jsx)(N,function(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?b(Object(r),!0).forEach((function(t){(0,n.Z)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):b(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}({},e),"messageGroup-".concat(t))}))})})})]}),(0,w.jsx)("div",{className:"absolute left-0 bottom-0 w-full h-24 border-t-2 border-gray-500 px-2 md:px-4 py-2 select-none",children:(0,w.jsxs)("div",{className:"flex gap-1 h-full",children:[(0,w.jsx)("div",{className:"flex w-12 md:w-16 h-full",children:(0,w.jsx)("div",{className:"relative self-center w-12 md:w-16 h-12 md:h-16 rounded-full bg-center bg-cover ".concat(t?"cursor-not-allowed":"cursor-pointer"),style:{backgroundImage:"url('/img/profile/".concat(S,".png')")},onClick:function(){if(!t){var e=g.hm.findIndex((function(e){return e==S}));-1===e||e===g.hm.length-1?(I(g.hm[0]),localStorage.setItem("profile",g.hm[0])):(I(g.hm[e+1]),localStorage.setItem("profile",g.hm[e+1]))}},children:(0,w.jsx)("div",{className:"absolute right-0 bottom-0 w-6 h-6 rounded-full p-1 ".concat(t?"bg-gray-400":"bg-purple-500"),children:(0,w.jsx)(u.G,{icon:d.V$d})})})}),(0,w.jsxs)("div",{className:"w-full h-full flex flex-col gap-2 pl-1 md:pl-2",children:[(0,w.jsx)("div",{className:"w-full sm:w-1/2 h-9 bg-white rounded-full px-3.5 overflow-hidden",children:(0,w.jsx)("input",{type:"text",className:"form-input w-full h-full px-0 rounded placeholder-gray-400 text-black tracking-wider border-none outline-none focus:ring-0 focus:ring-transparent",name:"nickname",placeholder:"\u540d\u5b57/\u66b1\u7a31",disabled:t,autoComplete:"off",value:o,onChange:function(e){return t=e.target.value,p(t),void localStorage.setItem("chatNickname",t);var t}})}),(0,w.jsxs)("div",{className:"relative flex justify-between gap-1 w-full h-9 bg-white rounded-full pl-3.5 pr-0.5 overflow-hidden",children:[(0,w.jsx)("div",{className:"w-full no-scrollbar overflow-y-scroll",style:{marginTop:"0.4rem"},children:(0,w.jsx)("textarea",{className:"form-textarea w-full h-full p-0 rounded placeholder-gray-400 text-black tracking-wider border-none outline-none focus:ring-0 focus:ring-transparent",name:"message",autoFocus:!0,placeholder:"\u8f38\u5165\u8a0a\u606f",disabled:t,autoComplete:"off",value:v,onChange:function(e){return k(e.target.value)},onKeyDown:function(e){return E(e)},ref:P})}),(0,w.jsx)("div",{className:"flex w-8 h-9",children:(0,w.jsx)("div",{className:"w-8 h-8 self-center rounded-full p-1.5 pl-1 ".concat(!t&&v&&v.split(/\n|\r|\r\n/g).join("")?"bg-purple-500 cursor-pointer":"bg-gray-400 cursor-not-allowed"),onClick:D,children:(0,w.jsx)(u.G,{icon:d.XCy})})}),(0,w.jsx)("button",{className:"hidden invisable",ref:C})]})]})]})})]})]})]})};function O(){var e=(0,i.useState)([]),t=e[0],r=e[1],n=(0,v.useQuery)("chats",f.zG,{refetchInterval:3e4}),a=n.data,l=n.isFetched,s=n.refetch;return(0,i.useEffect)((function(){var e=function(){var e=JSON.parse(localStorage.getItem("chatIds"));return e||localStorage.setItem("chatIds",JSON.stringify([])),e||[]}(),t=function(t){return{id:t.id,name:t.name,profileUrl:"/img/profile/".concat(t.profile,".png"),isSelf:e.includes(t.id),sentAt:t.sentAt,messages:[{sentAt:t.sentAt,text:t.text}]}};if(l){var n,s=[];a.chats.forEach((function(r,l){if(0!=l){if(!(o()(r.sentAt).diff(o()(n.sentAt))<3e5&&(e.includes(r.id)&&e.includes(n.id)||!e.includes(r.id)&&!e.includes(n.id)&&r.name==n.name)))return s.push(n),n=t(r),void(l==a.chats.length-1&&s.push(n));var c={sentAt:r.sentAt,text:r.text};n.messages.push(c),l==a.chats.length-1&&s.push(n)}else n=t(r)})),r(s)}}),[l,a]),(0,w.jsx)(x.Z,{title:"\u7559\u8a00\u677f",children:(0,w.jsx)(k,{disabled:!l,messageGroups:t,refetchChats:s})})}},8984:function(e,t,r){(window.__NEXT_P=window.__NEXT_P||[]).push(["/chat",function(){return r(2729)}])}},function(e){e.O(0,[774,523,330,797,612,888,179],(function(){return t=8984,e(e.s=t);var t}));var t=e.O();_N_E=t}]);